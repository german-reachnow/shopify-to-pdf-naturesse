<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopify CSV a PDF - Convertidor de Cat√°logos</title>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script>
    class ShopifyToPDF {
      constructor() {
        this.state = {
          csvFile: null,
          origin: 'bionaturesse',
          isProcessing: false,
          products: [],
          error: null
        };

        this.urlPatterns = {
          naturesse: 'https://naturesse.co/products/',
          bionaturesse: 'https://bionaturesse.co/products/',
          eljardindeeva: 'https://eljardindeeva.co/products/'
        };

        this.init();
      }

      setState(newState) {
        this.state = { ...this.state, ...newState };
        this.render();
      }

      formatPrice(price) {
        if (!price) return '-';
        const numPrice = parseFloat(price);
        if (isNaN(numPrice)) return '-';
        return `$ ${numPrice.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      }

      handleFileChange(e) {
        const file = e.target.files[0];
        if (file) {
          this.setState({ csvFile: file, error: null });
        }
      }

      setOrigin(origin) {
        this.setState({ origin });
      }

      processCSV() {
        if (!this.state.csvFile) {
          this.setState({ error: 'Por favor selecciona un archivo CSV' });
          return;
        }

        this.setState({ isProcessing: true, error: null });

        Papa.parse(this.state.csvFile, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            try {
              const processedProducts = this.processProducts(results.data);
              this.setState({ products: processedProducts, isProcessing: false });
            } catch (err) {
              this.setState({ error: `Error procesando CSV: ${err.message}`, isProcessing: false });
            }
          },
          error: (err) => {
            this.setState({ error: `Error leyendo CSV: ${err.message}`, isProcessing: false });
          }
        });
      }

      processProducts(data) {
        const productMap = new Map();
        
        data.forEach(row => {
          const handle = row.Handle;
          if (!handle || productMap.has(handle)) return;
          
          const baseUrl = this.urlPatterns[this.state.origin];
          const productUrl = `${baseUrl}${handle}`;
          
          const tags = row.Tags ? row.Tags.split(',').map(t => t.trim()).filter(t => t) : [];
          
          productMap.set(handle, {
            handle,
            title: row.Title || '',
            url: productUrl,
            vendor: row.Vendor || '',
            category: row['Product Category'] || '',
            type: row.Type || '',
            sku: row['Variant SKU'] || '',
            price: row['Variant Price'] || '',
            tags,
            imageSrc: row['Image Src'] || '',
            bodyHTML: row['Body (HTML)'] || ''
          });
        });
        
        return Array.from(productMap.values());
      }

      generateHTML() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('es-CO', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        const productsHTML = this.state.products.map(product => {
          const tagsHTML = product.tags.length > 0
            ? `<div class="chips">${product.tags.map(tag => `<span class="chip">${tag}</span>`).join('')}</div>`
            : '-';

          const bodyContent = product.bodyHTML.trim()
            ? product.bodyHTML
            : '<p class="small">Sin descripci√≥n.</p>';

          const jsonLD = {
            "@context": "https://schema.org",
            "@type": "Product",
            "name": product.title,
            "url": product.url,
            "image": [product.imageSrc],
            "brand": {
              "@type": "Brand",
              "name": product.vendor
            },
            "category": product.category,
            "offers": {
              "@type": "Offer",
              "priceCurrency": "COP",
              "price": parseFloat(product.price) || 0,
              "availability": "https://schema.org/InStock",
              "url": product.url
            }
          };

          return `
  <section class="product">
    <div class="header">
      <img src="${product.imageSrc}" alt="${product.title}">
      <div class="hgroup">
        <h2>${product.title}</h2>
        <table class="table">
          <tr><th class="label">url</th><td><div><a href="${product.url}">${product.url}</a></div></td></tr>
          <tr><th class="label">Vendor</th><td>${product.vendor || '-'}</td></tr>
          <tr><th class="label">Categor√≠a</th><td>${product.category || '-'}</td></tr>
          <tr><th class="label">Tipo</th><td>${product.type || '-'}</td></tr>
          <tr><th class="label">SKU</th><td>${product.sku || '-'}</td></tr>
          <tr>
      <th class="label">Precio</th>
      <td class="price">
        ${this.formatPrice(product.price)}
      </td>
    </tr>
          <tr><th class="label">Tags</th><td>${tagsHTML}</td></tr>
          <tr><th class="label">Imagen principal</th><td>${product.imageSrc}</td></tr>
        </table>
      </div>
    </div>
    
    <div class="body">
      ${bodyContent}
    </div>
    <script type="application/ld+json" class="jsonld">${JSON.stringify(jsonLD, null, 2)}
    <\/script>
  </section>`;
        }).join('');

        return `<!doctype html><html lang="es"><head>
  <meta charset="utf-8">
  <title>Catalogo IA</title>
  
  <style>
    @page { size: A4; margin: 20mm; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #111; }
    .cover { text-align:center; margin: 80px 0 40px; }
    .cover h1 { font-size: 28px; margin-bottom: 8px; }
    .meta { color:#555; font-size: 12px; }
    .product { page-break-before: always; padding-bottom: 40px; margin-bottom: 40px; border-bottom: 2px solid #e5e7eb; }
    .product:first-of-type { page-break-before: avoid; }
    .header { display:flex; gap:16px; align-items:flex-start; }
    .header img { max-width: 220px; max-height: 220px; object-fit: cover; border: 1px solid #eee; }
    .hgroup h2 { margin:0 0 4px; font-size: 20px; }
    .hgroup a { color:#1a73e8; text-decoration: none; word-break: break-all; }
    .table { margin: 8px 0; border-collapse: collapse; width: 100%; font-size: 12px; }
    .table th, .table td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
    .label { color:#555; width: 140px; white-space: nowrap; }
    .price { font-weight: 700; }
    .chips { display:flex; flex-wrap: wrap; gap:6px; margin-top:4px; }
    .chip { border:1px solid #ddd; border-radius: 999px; padding: 2px 8px; font-size: 11px; color:#333; }
    .body { margin-top: 10px; font-size: 13px; line-height: 1.45; }
    .gallery { display:flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .gallery img { width: 120px; height: 120px; object-fit: cover; border: 1px solid #eee; }
    .jsonld { display:none; }
    .small { font-size: 11px; color:#666; }
  </style>
</head><body>
  
  <div class="cover">
    <h1>Cat√°logo de Productos (para lectura por Agente IA)</h1>
    <div class="meta">Generado: ${dateStr}</div>
    <div class="meta">Total de productos: ${this.state.products.length}</div>
  </div>
  ${productsHTML}
</body></html>`;
      }

      downloadHTML() {
        const html = this.generateHTML();
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `catalogo-${this.state.origin}-${Date.now()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      printToPDF() {
        const html = this.generateHTML();
        const newWindow = window.open('', '_blank');
        
        if (!newWindow) {
          this.setState({ error: 'Por favor permite las ventanas emergentes para generar el PDF' });
          return;
        }
        
        newWindow.document.write(html);
        newWindow.document.close();
        
        newWindow.onload = () => {
          const images = newWindow.document.getElementsByTagName('img');
          let loadedImages = 0;
          const totalImages = images.length;
          
          if (totalImages === 0) {
            setTimeout(() => newWindow.print(), 500);
            return;
          }
          
          const checkAllLoaded = () => {
            loadedImages++;
            if (loadedImages === totalImages) {
              setTimeout(() => newWindow.print(), 500);
            }
          };
          
          Array.from(images).forEach(img => {
            if (img.complete) {
              checkAllLoaded();
            } else {
              img.onload = checkAllLoaded;
              img.onerror = checkAllLoaded;
            }
          });
        };
      }

      render() {
        const root = document.getElementById('root');
        const { csvFile, origin, isProcessing, products, error } = this.state;

        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-8">
            <div class="max-w-4xl mx-auto">
              <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                  <h1 class="text-4xl font-bold text-gray-800 mb-2">
                    Shopify CSV a PDF
                  </h1>
                  <p class="text-gray-600">
                    Convierte tu cat√°logo de productos en un PDF profesional
                  </p>
                </div>

                <!-- Selecci√≥n de origen -->
                <div class="mb-6">
                  <label class="block text-sm font-semibold text-gray-700 mb-3">
                    Origen de los productos
                  </label>
                  <div class="grid grid-cols-3 gap-3">
                    ${Object.keys(this.urlPatterns).map(key => `
                      <button
                        onclick="app.setOrigin('${key}')"
                        class="px-4 py-3 rounded-lg font-medium transition-all ${
                          origin === key
                            ? 'bg-indigo-600 text-white shadow-lg scale-105'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }"
                      >
                        ${key === 'naturesse' ? 'Naturesse' : ''}
                        ${key === 'bionaturesse' ? 'BioNaturesse' : ''}
                        ${key === 'eljardindeeva' ? 'El Jard√≠n de Eva' : ''}
                      </button>
                    `).join('')}
                  </div>
                </div>

                <!-- Selecci√≥n de archivo -->
                <div class="mb-6">
                  <label class="block text-sm font-semibold text-gray-700 mb-3">
                    Archivo CSV de Shopify
                  </label>
                  <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors">
                    <input
                      type="file"
                      accept=".csv"
                      onchange="app.handleFileChange(event)"
                      class="hidden"
                      id="csv-upload"
                    />
                    <label for="csv-upload" class="cursor-pointer">
                      <div class="text-gray-600 mb-2">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                      </div>
                      <p class="text-sm font-medium text-gray-700">
                        ${csvFile ? csvFile.name : 'Haz clic para seleccionar un archivo CSV'}
                      </p>
                      <p class="text-xs text-gray-500 mt-1">
                        Archivo de exportaci√≥n de productos de Shopify
                      </p>
                    </label>
                  </div>
                </div>

                <!-- Bot√≥n de procesamiento -->
                <button
                  onclick="app.processCSV()"
                  ${!csvFile || isProcessing ? 'disabled' : ''}
                  class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors mb-4"
                >
                  ${isProcessing ? 'Procesando...' : 'Procesar CSV'}
                </button>

                <!-- Error -->
                ${error ? `
                  <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
                    ${error}
                  </div>
                ` : ''}

                <!-- Resultados -->
                ${products.length > 0 ? `
                  <div class="mt-6 bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                      <div>
                        <h3 class="text-lg font-semibold text-green-800">
                          ‚úì Productos procesados
                        </h3>
                        <p class="text-sm text-green-700">
                          ${products.length} producto${products.length !== 1 ? 's' : ''} encontrado${products.length !== 1 ? 's' : ''}
                        </p>
                      </div>
                    </div>

                    <div class="flex gap-3">
                      <button
                        onclick="app.printToPDF()"
                        class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                      >
                        üìÑ Imprimir como PDF
                      </button>
                      <button
                        onclick="app.downloadHTML()"
                        class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                      >
                        üíæ Descargar HTML
                      </button>
                    </div>

                    <div class="mt-4 text-xs text-green-700">
                      <p class="font-medium mb-1">Productos procesados:</p>
                      <ul class="list-disc list-inside space-y-1 max-h-40 overflow-y-auto">
                        ${products.map(product => `<li>${product.title}</li>`).join('')}
                      </ul>
                    </div>
                  </div>
                ` : ''}

                <!-- Instrucciones -->
                <div class="mt-8 bg-gray-50 rounded-lg p-6">
                  <h3 class="text-sm font-semibold text-gray-700 mb-3">
                    üìã Instrucciones
                  </h3>
                  <ol class="text-sm text-gray-600 space-y-2 list-decimal list-inside">
                    <li>Selecciona el origen de los productos (Naturesse, BioNaturesse o El Jard√≠n de Eva)</li>
                    <li>Carga el archivo CSV exportado desde Shopify</li>
                    <li>Haz clic en "Procesar CSV" para analizar los productos</li>
                    <li>Usa "Imprimir como PDF" para generar el PDF (usa Ctrl/Cmd + P para guardar)</li>
                    <li>O descarga el archivo HTML para abrirlo en tu navegador</li>
                  </ol>
                  <p class="text-xs text-gray-500 mt-3">
                    Nota: El sistema solo toma la primera aparici√≥n de cada producto (identificado por el Handle) y descarta las l√≠neas duplicadas.
                  </p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      init() {
        this.render();
      }
    }

    // Inicializar la aplicaci√≥n
    const app = new ShopifyToPDF();
  </script>
</body>
</html>
